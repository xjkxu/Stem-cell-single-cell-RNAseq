---
title: "xu16_19_29_32_vs_17_33_38"
output: html_document
---

## Load all packages
```{r}

library("rlang")
library("Seurat");
library("sctransform");
library("dplyr");
library("RColorBrewer");
library("ggthemes");
library("ggplot2");
library("cowplot");
library("data.table");
library("scales")


```


## Set up Seurat object
```{r}
## Find the origial CR path

setwd("C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu16_2017_cus_CR310_S150_L151")

setwd("C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu19_2017_cus_CR310_S150_L151")

setwd("C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu29_B73_tip")

setwd("C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu32_B73_tip")

setwd("C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu17_2017_cus_CR310_S150_L150")

setwd("C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu33_fea3cle7_L150")

setwd("C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu38_fea3cle7")




## Read in the feature-barcode matrices generated by the cellranger pipeline.

memory.limit(size=50000000)

samples=c("xu16","xu19","xu29","xu32", "xu17", "xu33", "xu38")

data.10x = list()

data.10x[[1]] <- Read10X(data.dir = "C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu16_2017_cus_CR310_S150_L151/raw_feature_bc_matrix");

data.10x[[2]] <- Read10X(data.dir = "C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu19_2017_cus_CR310_S150_L151/raw_feature_bc_matrix");

data.10x[[3]] <- Read10X(data.dir = "C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu29_B73_tip/raw_feature_bc_matrix");

data.10x[[4]] <- Read10X(data.dir = "C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu32_B73_tip/raw_feature_bc_matrix");


data.10x[[5]] <- Read10X(data.dir = "C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu17_2017_cus_CR310_S150_L150/raw_feature_bc_matrix");

data.10x[[6]] <- Read10X(data.dir = "C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu33_fea3cle7_L150/raw_feature_bc_matrix");

data.10x[[7]] <- Read10X(data.dir = "C:/Users/Xiaosa Xu/Desktop/Seurat_2020/xu38_fea3cle7/raw_feature_bc_matrix");



## Convert each feature-barcode matrix to a Seurat object.

B73vsfea3cle7.list = list(); # First create an empty list to hold the Seurat objects

B73vsfea3cle7.list[[1]] = CreateSeuratObject(counts = data.10x[[1]], min.cells=3, min.features=200, project=samples[1]);

B73vsfea3cle7.list[[1]][["DataSet"]] = samples[1];


B73vsfea3cle7.list[[2]] = CreateSeuratObject(counts = data.10x[[2]], min.cells=3, min.features=200, project=samples[2]);

B73vsfea3cle7.list[[2]][["DataSet"]] = samples[2];


B73vsfea3cle7.list[[3]] = CreateSeuratObject(counts = data.10x[[3]], min.cells=3, min.features=200, project=samples[3]);

B73vsfea3cle7.list[[3]][["DataSet"]] = samples[3];


B73vsfea3cle7.list[[4]] = CreateSeuratObject(counts = data.10x[[4]], min.cells=3, min.features=200, project=samples[4]);

B73vsfea3cle7.list[[4]][["DataSet"]] = samples[4];


B73vsfea3cle7.list[[5]] = CreateSeuratObject(counts = data.10x[[5]], min.cells=3, min.features=200, project=samples[5]);

B73vsfea3cle7.list[[5]][["DataSet"]] = samples[5];


B73vsfea3cle7.list[[6]] = CreateSeuratObject(counts = data.10x[[6]], min.cells=3, min.features=200, project=samples[6]);

B73vsfea3cle7.list[[6]][["DataSet"]] = samples[6];


B73vsfea3cle7.list[[7]] = CreateSeuratObject(counts = data.10x[[7]], min.cells=3, min.features=200, project=samples[7]);

B73vsfea3cle7.list[[7]][["DataSet"]] = samples[7];



## Optional, remove the raw data to save space:

rm(data.10x);


### Subset each library before merge or integrate


B73vsfea3cle7.list[[1]] <- subset(B73vsfea3cle7.list[[1]], subset = nCount_RNA > 5000 & nFeature_RNA > 1000 & nCount_RNA < 150000 & nFeature_RNA < 15000)

B73vsfea3cle7.list[[2]] <- subset(B73vsfea3cle7.list[[2]], subset = nCount_RNA > 5000 & nFeature_RNA > 1000 & nCount_RNA < 150000 & nFeature_RNA < 15000)

B73vsfea3cle7.list[[3]] <- subset(B73vsfea3cle7.list[[3]], subset = nCount_RNA > 5000 & nFeature_RNA > 1000 & nCount_RNA < 150000 & nFeature_RNA < 15000)

B73vsfea3cle7.list[[4]] <- subset(B73vsfea3cle7.list[[4]], subset = nCount_RNA > 5000 & nFeature_RNA > 1000 & nCount_RNA < 150000 & nFeature_RNA < 15000)

B73vsfea3cle7.list[[5]] <- subset(B73vsfea3cle7.list[[5]], subset = nCount_RNA > 5000 & nFeature_RNA > 1000 & nCount_RNA < 150000 & nFeature_RNA < 15000)

B73vsfea3cle7.list[[6]] <- subset(B73vsfea3cle7.list[[6]], subset = nCount_RNA > 5000 & nFeature_RNA > 1000 & nCount_RNA < 150000 & nFeature_RNA < 15000)

B73vsfea3cle7.list[[7]] <- subset(B73vsfea3cle7.list[[7]], subset = nCount_RNA > 5000 & nFeature_RNA > 1000 & nCount_RNA < 150000 & nFeature_RNA < 15000)


##

B73vsfea3cle7.list[[1]]@meta.data$source <- "B73"
B73vsfea3cle7.list[[2]]@meta.data$source <- "B73"
B73vsfea3cle7.list[[3]]@meta.data$source <- "B73"
B73vsfea3cle7.list[[4]]@meta.data$source <- "B73"

B73vsfea3cle7.list[[5]]@meta.data$source <- "cle7fea3"
B73vsfea3cle7.list[[6]]@meta.data$source <- "cle7fea3"
B73vsfea3cle7.list[[7]]@meta.data$source <- "cle7fea3"

## logNormalize

B73vsfea3cle7.list[[1]]<- NormalizeData(B73vsfea3cle7.list[[1]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.list[[2]]<- NormalizeData(B73vsfea3cle7.list[[2]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.list[[3]]<- NormalizeData(B73vsfea3cle7.list[[3]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.list[[4]]<- NormalizeData(B73vsfea3cle7.list[[4]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.list[[5]]<- NormalizeData(B73vsfea3cle7.list[[5]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.list[[6]]<- NormalizeData(B73vsfea3cle7.list[[6]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.list[[7]]<- NormalizeData(B73vsfea3cle7.list[[7]], normalization.method = "LogNormalize", scale.factor = 10000)

##Find variables


B73vsfea3cle7.list[[1]]<- FindVariableFeatures(B73vsfea3cle7.list[[1]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.list[[2]]<- FindVariableFeatures(B73vsfea3cle7.list[[2]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.list[[3]]<- FindVariableFeatures(B73vsfea3cle7.list[[3]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.list[[4]]<- FindVariableFeatures(B73vsfea3cle7.list[[4]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.list[[5]]<- FindVariableFeatures(B73vsfea3cle7.list[[5]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.list[[6]]<- FindVariableFeatures(B73vsfea3cle7.list[[6]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.list[[7]]<- FindVariableFeatures(B73vsfea3cle7.list[[7]], selection.method = "vst", nfeatures = 2000)

# select features that are repeatedly variable across datasets for integration


features <- SelectIntegrationFeatures(object.list = B73vsfea3cle7.list)

# find anchors

anchors <- FindIntegrationAnchors(object.list = B73vsfea3cle7.list, anchor.features = features)


# Integrate data
# this command creates an 'integrated' data assay

B73vsfea3cle7.individual.int <- IntegrateData(anchorset = anchors)

DefaultAssay(B73vsfea3cle7.individual.int)<-"integrated"


# Run the standard workflow for visualization and clustering
B73vsfea3cle7.individual.int <- ScaleData(B73vsfea3cle7.individual.int, verbose = FALSE)
B73vsfea3cle7.individual.int <- RunPCA(B73vsfea3cle7.individual.int, npcs = 30, verbose = FALSE)


```



```{r}
## Determine the ‘dimensionality’ of the dataset

ElbowPlot(B73vsfea3cle7.individual.int, ndims = 40)

## Elbow plot: quantitative approach
## https://hbctraining.github.io/scRNA-seq/lessons/elbow_plot_metric.html


# Determine percent of variation associated with each PC
pct <- B73vsfea3cle7.individual.int[["pca"]]@stdev / sum(B73vsfea3cle7.individual.int[["pca"]]@stdev) * 100

# Calculate cumulative percents for each PC
cumu <- cumsum(pct)

# Determine which PC exhibits cumulative percent greater than 90% and % variation associated with the PC as less than 5
co1 <- which(cumu > 90 & pct < 5)[1]

co1

# Determine the difference between variation of PC and subsequent PC
co2 <- sort(which((pct[1:length(pct) - 1] - pct[2:length(pct)]) > 0.1), decreasing = T)[1] + 1

# last point where change of % of variation is more than 0.1%.
co2

# Minimum of the two calculation
pcs <- min(co1, co2)

pcs


```



```{r}
B73vsfea3cle7.individual.int <- RunUMAP(B73vsfea3cle7.individual.int, reduction = "pca", dims = 1:19) ## Use default 30, or change the PC number based on above Elbow plot: quantitative approach

B73vsfea3cle7.individual.int <- FindNeighbors(B73vsfea3cle7.individual.int, reduction = "pca", dims = 1:19)

B73vsfea3cle7.individual.int <- FindClusters(B73vsfea3cle7.individual.int, resolution = 0.85)

# Visualization

DimPlot(B73vsfea3cle7.individual.int, reduction = "umap", label = TRUE, pt.size = 1)
DimPlot(B73vsfea3cle7.individual.int, reduction = "umap", group.by = "orig.ident")

## two plots next to each other 

p1 <- DimPlot(B73vsfea3cle7.individual.int, reduction = "umap", group.by = "orig.ident")
p2 <- DimPlot(B73vsfea3cle7.individual.int, reduction = "umap", label = TRUE, repel = TRUE)
p1 + p2

### split the UMAPs by samples 

DimPlot(B73vsfea3cle7.individual.int, reduction = "umap", split.by = "orig.ident", pt.size = 1)


### group the UMAPs by samples. 

DimPlot(B73vsfea3cle7.individual.int, reduction = "umap", group.by = "orig.ident", pt.size = 1)

```

```{r}
## Remove cluster 16 with very low UMI (dead cells)

B73vsfea3cle7.individual.int_remove_dead <- subset(B73vsfea3cle7.individual.int, idents = 16, invert = TRUE)

DimPlot(B73vsfea3cle7.individual.int_remove_dead, reduction = "umap", label = TRUE, pt.size = 1)

### split the integrated object to re-normalize and process

B73vsfea3cle7.rmdead.list <- SplitObject(B73vsfea3cle7.individual.int_remove_dead, split.by = "orig.ident")

B73vsfea3cle7.rmdead.list

```


```{r}
## need to set RNA assay before normalization and processing 

DefaultAssay(B73vsfea3cle7.rmdead.list[[1]]) <- "RNA"
DefaultAssay(B73vsfea3cle7.rmdead.list[[2]]) <- "RNA"
DefaultAssay(B73vsfea3cle7.rmdead.list[[3]]) <- "RNA"
DefaultAssay(B73vsfea3cle7.rmdead.list[[4]]) <- "RNA"
DefaultAssay(B73vsfea3cle7.rmdead.list[[5]]) <- "RNA"
DefaultAssay(B73vsfea3cle7.rmdead.list[[6]]) <- "RNA"
DefaultAssay(B73vsfea3cle7.rmdead.list[[7]]) <- "RNA"



## logNormalize

B73vsfea3cle7.rmdead.list[[1]]<- NormalizeData(B73vsfea3cle7.rmdead.list[[1]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.rmdead.list[[2]]<- NormalizeData(B73vsfea3cle7.rmdead.list[[2]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.rmdead.list[[3]]<- NormalizeData(B73vsfea3cle7.rmdead.list[[3]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.rmdead.list[[4]]<- NormalizeData(B73vsfea3cle7.rmdead.list[[4]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.rmdead.list[[5]]<- NormalizeData(B73vsfea3cle7.rmdead.list[[5]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.rmdead.list[[6]]<- NormalizeData(B73vsfea3cle7.rmdead.list[[6]], normalization.method = "LogNormalize", scale.factor = 10000)

B73vsfea3cle7.rmdead.list[[7]]<- NormalizeData(B73vsfea3cle7.rmdead.list[[7]], normalization.method = "LogNormalize", scale.factor = 10000)

## Find variables


B73vsfea3cle7.rmdead.list[[1]]<- FindVariableFeatures(B73vsfea3cle7.rmdead.list[[1]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.rmdead.list[[2]]<- FindVariableFeatures(B73vsfea3cle7.rmdead.list[[2]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.rmdead.list[[3]]<- FindVariableFeatures(B73vsfea3cle7.rmdead.list[[3]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.rmdead.list[[4]]<- FindVariableFeatures(B73vsfea3cle7.rmdead.list[[4]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.rmdead.list[[5]]<- FindVariableFeatures(B73vsfea3cle7.rmdead.list[[5]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.rmdead.list[[6]]<- FindVariableFeatures(B73vsfea3cle7.rmdead.list[[6]], selection.method = "vst", nfeatures = 2000)

B73vsfea3cle7.rmdead.list[[7]]<- FindVariableFeatures(B73vsfea3cle7.rmdead.list[[7]], selection.method = "vst", nfeatures = 2000)


# select features that are repeatedly variable across datasets for integration


features <- SelectIntegrationFeatures(object.list = B73vsfea3cle7.rmdead.list)

# find anchors

anchors <- FindIntegrationAnchors(object.list = B73vsfea3cle7.rmdead.list, anchor.features = features)


# Integrate data
# this command creates an 'integrated' data assay

B73vsfea3cle7.individual.rmdead.int <- IntegrateData(anchorset = anchors)


DefaultAssay(B73vsfea3cle7.individual.rmdead.int)<-"integrated"


# Run the standard workflow for visualization and clustering
B73vsfea3cle7.individual.rmdead.int <- ScaleData(B73vsfea3cle7.individual.rmdead.int, verbose = FALSE)
B73vsfea3cle7.individual.rmdead.int <- RunPCA(B73vsfea3cle7.individual.rmdead.int, npcs = 30, verbose = FALSE)


```



```{r}
## Determine the ‘dimensionality’ of the dataset

ElbowPlot(B73vsfea3cle7.individual.rmdead.int, ndims = 40)

## Elbow plot: quantitative approach
## https://hbctraining.github.io/scRNA-seq/lessons/elbow_plot_metric.html


# Determine percent of variation associated with each PC
pct <- B73vsfea3cle7.individual.rmdead.int[["pca"]]@stdev / sum(B73vsfea3cle7.individual.rmdead.int[["pca"]]@stdev) * 100

# Calculate cumulative percents for each PC
cumu <- cumsum(pct)

# Determine which PC exhibits cumulative percent greater than 90% and % variation associated with the PC as less than 5
co1 <- which(cumu > 90 & pct < 5)[1]

co1


# Determine the difference between variation of PC and subsequent PC
co2 <- sort(which((pct[1:length(pct) - 1] - pct[2:length(pct)]) > 0.1), decreasing = T)[1] + 1

# last point where change of % of variation is more than 0.1%.
co2

# Minimum of the two calculation
pcs <- min(co1, co2)

pcs

```



```{r}
B73vsfea3cle7.individual.rmdead.int <- RunUMAP(B73vsfea3cle7.individual.rmdead.int, reduction = "pca", dims = 1:24) ## Use default 30, or change the PC number based on above Elbow plot: quantitative approach

B73vsfea3cle7.individual.rmdead.int <- FindNeighbors(B73vsfea3cle7.individual.rmdead.int, reduction = "pca", dims = 1:24)

B73vsfea3cle7.individual.rmdead.int <- FindClusters(B73vsfea3cle7.individual.rmdead.int, resolution = 0.65)

# Visualization

DimPlot(B73vsfea3cle7.individual.rmdead.int, reduction = "umap", label = TRUE, pt.size = 1)

DimPlot(B73vsfea3cle7.individual.rmdead.int, reduction = "umap", group.by = "orig.ident")

## two plots next to each other 

p1 <- DimPlot(B73vsfea3cle7.individual.rmdead.int, reduction = "umap", group.by = "orig.ident")
p2 <- DimPlot(B73vsfea3cle7.individual.rmdead.int, reduction = "umap", label = TRUE, repel = TRUE)
p1 + p2

### split the UMAPs by samples 

DimPlot(B73vsfea3cle7.individual.rmdead.int, reduction = "umap", split.by = "orig.ident", pt.size = 1)


### group the UMAPs by samples. 

DimPlot(B73vsfea3cle7.individual.rmdead.int, reduction = "umap", group.by = "orig.ident", pt.size = 1)

```

```{r}
### identify DEG for specific clusters. 


B73vsfea3cle7.individual.rmdead.int.forDEG <- B73vsfea3cle7.individual.rmdead.int ## assign to new object so it won't mess up the source labels. 


B73vsfea3cle7.individual.rmdead.int.forDEG$celltype.source <- paste(Idents(B73vsfea3cle7.individual.rmdead.int.forDEG), B73vsfea3cle7.individual.rmdead.int.forDEG$source, sep = "_")

B73vsfea3cle7.individual.rmdead.int.forDEG$celltype <- Idents(B73vsfea3cle7.individual.rmdead.int.forDEG)

Idents(B73vsfea3cle7.individual.rmdead.int.forDEG) <- "celltype.source"

### SPM Stem cell DEG

b.interferon.response <- FindMarkers(B73vsfea3cle7.individual.rmdead.int.forDEG, ident.1 = "1_B73", ident.2 = "1_cle7fea3", verbose = FALSE)

write.csv(b.interferon.response, file = "Cluster1_SPM.stemcell_DEG_B73vsfea3cle7.individual.rmdead.int.forDEG.csv")

### SPM Stem cell DEG--No default cutoff

b.interferon.response <- FindMarkers(B73vsfea3cle7.individual.rmdead.int.forDEG, ident.1 = "1_B73", ident.2 = "1_cle7fea3", verbose = FALSE, logfc.threshold = 0, min.pct = 0, min.cells.feature = 1,   min.cells.group = 1)

write.csv(b.interferon.response, file = "B73-WT_vs_fea3cle7-mutant_cluster1.SPM.stemcell_Seurat-wilcox_NoDefault-cutoff.csv")




### IM Stem cell DEG

b.interferon.response <- FindMarkers(B73vsfea3cle7.individual.rmdead.int.forDEG, ident.1 = "9_B73", ident.2 = "9_cle7fea3", verbose = FALSE)

write.csv(b.interferon.response, file = "Cluster9_IM.stemcell_DEG_B73vsfea3cle7.individual.rmdead.int.forDEG.csv")


### IM Stem cell DEG--No default cutoff

b.interferon.response <- FindMarkers(B73vsfea3cle7.individual.rmdead.int.forDEG, ident.1 = "9_B73", ident.2 = "9_cle7fea3", verbose = FALSE, logfc.threshold = 0, min.pct = 0, min.cells.feature = 1,   min.cells.group = 1)

write.csv(b.interferon.response, file = "B73-WT_vs_fea3cle7-mutant_cluster9.IM.stemcell_Seurat-wilcox_NoDefault-cutoff.csv")


```
